<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Visual Composer</title>
    <link href="css/bootstrap.min.css" rel="stylesheet" media="all" type="text/css"/>
    <link href="css/bootstrap-theme.min.css" rel="stylesheet" media="all" type="text/css"/>
    <link href="css/custom.css" rel="stylesheet" media="all" type="text/css"/>
    <script src="js/jquery-2.1.3.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/d3.v3.min.js"></script>
    <script src="js/custom.js"></script>
    <script src="js/live.js"></script>


</head>
<body>

<div id="elem-right-click" style="display: none; width:40px; height: 100px">
    <button type="button" name="name" value="delete" >Delete</button>
</div>

<script>


    var svgCanvasH = 560, svgCanvasW = 1024;

    var operatorsConfig = {
        height  : 250,
        width   : 300,
        x   : 10,
        y   : 20,
        background  : 'grey'

    };

    var streamsConfig = {
        height  : 250,
        width   : 300,
        x   : 10,
        y   : 280,
        background  : 'grey'

    };

    var drawingConfig = {
        height  : 510,
        width   : 690,
        x   : 320,
        y   : 20,
        background  : 'grey'

    };


    //draw the layout
    var mainLayout = d3.select("body")
            .append('svg')
            .attr('height', svgCanvasH)
            .attr('width', svgCanvasW)
            .style('background', '#aaffff');

    //draw the operators region
    var operators = mainLayout
            .append('rect')
            .attr('x', operatorsConfig.x)
            .attr('y',operatorsConfig.y)
            .attr('height',operatorsConfig.height)
            .attr('width',operatorsConfig.width)
            .style('fill',operatorsConfig.background)


    ;

    var operatorsTitle = mainLayout
            .append('text')
            .attr('x', operatorsConfig.x+20)
            .attr('y', operatorsConfig.y+22)
            .text('Operators')
            .style({
                'font-size':20,
                'fill':'blue'
            });

    //draw the streams layout
    var streams = mainLayout
            .append('rect')
            .attr('x', streamsConfig.x)
            .attr('y',streamsConfig.y)
            .attr('height',streamsConfig.height)
            .attr('width',streamsConfig.width)
            .style('fill',streamsConfig.background);


    var streamsTitle = mainLayout
            .append('text')
            .attr('x', streamsConfig.x+20)
            .attr('y', streamsConfig.y+22)
            .text('Streams')
            .style({
                'font-size':20,
                'fill':'blue'
            });

    //draw the drawing layout
    var drawings = mainLayout
            .append('rect')
            .attr('x', drawingConfig.x)
            .attr('y',drawingConfig.y)
            .attr('height',drawingConfig.height)
            .attr('width',drawingConfig.width)
            .style('fill',drawingConfig.background);



    var icons = ['filter.png', 'join.png', 'pattern.png', 'sequence.png', 'windows.png',];

    var W = operatorsConfig.width; var H=operatorsConfig.height;
    var x = 25, y=45, w=35, h=40;

    n = Math.round((W-x)/(w+x));
    m = Math.round((H-y)/(h+y));

    var coordinates = [];
    var row = 0, col=0;
    for(i=0; i<icons.length; i++){

        x_i = (col+1)*x + col*x;
        y_i = (row+1)*y + row*y;
        alpha = [x_i, y_i];

        coordinates.push(alpha);
        col+=1;

        if(col==n){
            row+=1;
            col=0
        }

    }



    console.log(coordinates);
    function move() {
        d3.select(this)
//                                            .attr("transform", "translate(" + d3.event.x + "," + d3.event.y + ")");
                .attr('x', d3.event.x - parseInt(d3.select(this).attr("width")) / 2)
                .attr('y', d3.event.y - parseInt(d3.select(this).attr("height")) / 2)
    }

    var drag = d3.behavior.drag()
                    .on("drag", move)
                    .on("dragend", function(d){
                        var elem = d3.select(this);
                        elem.attr('x', elem.attr('initial-x'));
                        elem.attr('y', elem.attr('initial-y'));

                        var mouseLoc = d3.mouse(this);

                        if(mouseLoc[0] > 320){
                            mainLayout
                                    .append('svg:image')
                                    .attr('width', elem.attr('width'))
                                    .attr('height', elem.attr('height'))
                                    .attr('x', mouseLoc[0])
                                    .attr('initial-x', mouseLoc[0])
                                    .attr('y', mouseLoc[1])
                                    .attr('initial-y', mouseLoc[1])
                                    .attr('xlink:href', elem.attr('href'))
                                    .on('contextmenu', function(d, i){
                                        var curElem = d3.select(this);
                                        d3.event.preventDefault();
//                                        alert('right click disabled');
                                        var position = d3.mouse(this);
                                        d3.select('#elem-right-click')
                                                .style('position', 'absolute')
                                                .style('left', position[0] + "px")
                                                .style('top', position[1] + "px")
                                                .style('display', 'block')
                                                .on('click', function(d, i){
                                                    curElem.remove();
                                                    d3.select(this).style('display', 'none');
                                                })
                                        ;


                                    })
                                    .call(d3.behavior.drag()
                                            .on('drag', move)
                                            .on('dragend', function(){
                                                var mouseCoordinates = d3.mouse(this);
//                                                if(mouseCoordinates[0] >= 925 && mouseCoordinates[1]<= 105){
//                                                    var ip = confirm('Are you sure you wanna delete the item? ');
//                                                    if(ip == true){
//                                                        this.remove();
//                                                    }else{
//                                                        var elem = d3.select(this);
//                                                        elem.attr("x",elem.attr("initial-x"));
//                                                        elem.attr("y",elem.attr("initial-y"));
//
//                                                    }
//                                                }else
                                                if(mouseCoordinates[0]<320 || mouseCoordinates[1]<=44 || mouseCoordinates[0]>= 980 || mouseCoordinates[1]>= 500){
                                                    var elem = d3.select(this);
                                                    elem.attr("x",elem.attr("initial-x"));
                                                    elem.attr("y",elem.attr("initial-y"));
                                                }
                                            })
                                            )
                            ;

                        }

                    })
            ;

    mainLayout.selectAll("image")

            .data(icons)
            .enter()
            .append("svg:image")
            .attr("xlink:href", function(d){
                return "images/icons/"+d;
            })
            .attr('class','drg')
            .attr("width", w)
            .attr("height", h)
            .attr("x", function(d, i){
                return coordinates[i][0];
//                                            return i*10;
            })
            .attr("initial-x", function(d, i){
                return coordinates[i][0];
            })
            .attr("y",function(d, i){
                return coordinates[i][1];
//                                            return i*10;
            })
            .attr('initial-y', function(d, i){
                return coordinates[i][1];
            })
            .call(drag)


    ;


</script>


</body>
</html>