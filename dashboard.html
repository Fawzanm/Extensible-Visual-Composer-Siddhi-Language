<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Visual Composer</title>
    <link href="css/bootstrap.min.css" rel="stylesheet" media="all" type="text/css"/>
    <link href="css/bootstrap-theme.min.css" rel="stylesheet" media="all" type="text/css"/>
    <link href="css/custom.css" rel="stylesheet" media="all" type="text/css"/>
    <script src="js/jquery-2.1.3.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/d3.v3.min.js"></script>
    <script src="js/custom.js"></script>
    <script src="js/live.js"></script>



</head>
<body>



<div id="elem-right-click" style="display: none; width:40px; height: 100px">
    <button type="button" name="name" value="delete" >Delete</button>
</div>

<script>


    var svgCanvasH = 560, svgCanvasW = 1024;

    var operatorsConfig = {
        height  : 250,
        width   : 300,
        x   : 10,
        y   : 20,
        background  : 'grey'

    };

    var streamsConfig = {
        height  : 250,
        width   : 300,
        x   : 10,
        y   : 280,
        background  : 'grey'

    };

    var drawingConfig = {
        height  : 510,
        width   : 690,
        x   : 320,
        y   : 20,
        background  : 'grey'

    };


    //draw the layout
    var mainLayout = d3.select("body")
            .append('svg')
            .attr('height', svgCanvasH)
            .attr('width', svgCanvasW)
            .style('background', '#aaffff');

    //draw the operators region
    var operators = mainLayout
                    .append('rect')
                    .attr('x', operatorsConfig.x)
                    .attr('y',operatorsConfig.y)
                    .attr('height',operatorsConfig.height)
                    .attr('width',operatorsConfig.width)
                    .style('fill',operatorsConfig.background)


            ;

    var operatorsTitle = mainLayout
            .append('text')
            .attr('x', operatorsConfig.x+20)
            .attr('y', operatorsConfig.y+22)
            .text('Operators')
            .style({
                'font-size':20,
                'fill':'blue'
            });

    //draw the streams layout
    var streams = mainLayout
            .append('rect')
            .attr('id','streams')
            .attr('x', streamsConfig.x)
            .attr('y',streamsConfig.y)
            .attr('height',streamsConfig.height)
            .attr('width',streamsConfig.width)
            .style('fill',streamsConfig.background);


    var streamsTitle = mainLayout
            .append('text')
            .attr('x', streamsConfig.x+20)
            .attr('y', streamsConfig.y+22)
            .text('Streams')
            .style({
                'font-size':20,
                'fill':'blue'
            });

    //draw the drawing layout
    var drawings = mainLayout
            .append('rect')
            .attr('x', drawingConfig.x)
            .attr('y',drawingConfig.y)
            .attr('height',drawingConfig.height)
            .attr('width',drawingConfig.width)
            .style('fill',drawingConfig.background);



    var icons = ['filter.png', 'join.png', 'pattern.png', 'sequence.png', 'windows.png'];

    var W = operatorsConfig.width; var H=operatorsConfig.height;
    var x = 25, y=45, w=35, h=40;

    n = Math.round((W-x)/(w+x));
    m = Math.round((H-y)/(h+y));

    var coordinates = [];
    var row = 0, col=0;
    var i;
    for(i=0; i<icons.length; i++){

        var x_i = (col+1)*x + col*x;
        var y_i = (row+1)*y + row*y;
        var alpha = [x_i, y_i];

        coordinates.push(alpha);
        col+=1;

        if(col==n){
            row+=1;
            col=0
        }

    }



    console.log(coordinates);
    function move() {
        d3.select(this)
//                                            .attr("transform", "translate(" + d3.event.x + "," + d3.event.y + ")");
                .attr('x', d3.event.x - parseInt(d3.select(this).attr("width")) / 2)
                .attr('y', d3.event.y - parseInt(d3.select(this).attr("height")) / 2)
    }


    var dragStream= d3.behavior.drag()
//                    .on('dragstart', function(){
//                        console.log('drg' + d3.select(this).attr('draggable'));
//                        if(d3.select(this).attr('draggable') == 'false'){
//                            drag.trigger("dragend")
//                        }
//                    })
            .on('drag', function(d,i){
                        var elem = d3.select(this);
                        if(elem.attr('draggable') == 'true'){
                            if(d3.select(this).datum().drag) move.call(this, d, i);
//                            return 0;
                        }

                    })
            .on('dragend', function(){

                var elem = d3.select(this);
                    if(elem.attr('draggable') == 'false'){
                        return 0;
                    }
                elem.attr('x', elem.attr('initial-x'));
                elem.attr('y', elem.attr('initial-y'));

                var mouseLoc = d3.mouse(this);

                if(mouseLoc[0] > 320){
                    mainLayout
                            .append('rect')
                            .attr('width', elem.attr('width'))
                            .attr('height', elem.attr('height'))
                            .attr('x', mouseLoc[0])
                            .attr('initial-x', mouseLoc[0])
                            .attr('y', mouseLoc[1])
                            .attr('initial-y', mouseLoc[1])
                            .style('fill', 'white')
                            .on('contextmenu', function(d, i){
                                var curElem = d3.select(this);
                                d3.event.preventDefault();
//                                        alert('right click disabled');
                                var position = d3.mouse(this);
                                d3.select('#elem-right-click')
                                        .style('position', 'absolute')
                                        .style('left', position[0] + "px")
                                        .style('top', position[1] + "px")
                                        .style('display', 'block')
                                        .on('click', function(d, i){

                                            var conf = confirm('Confiem Delete?');
                                            if(conf){
                                                curElem.remove();
                                            }

                                            d3.select(this).style('display', 'none');


                                        })
                                ;


                            })
                            .call(d3.behavior.drag()
                                    .on('drag', move)
                                    .on('dragend', function(){
                                        var mouseCoordinates = d3.mouse(this);
//                                                if(mouseCoordinates[0] >= 925 && mouseCoordinates[1]<= 105){
//                                                    var ip = confirm('Are you sure you wanna delete the item? ');
//                                                    if(ip == true){
//                                                        this.remove();
//                                                    }else{
//                                                        var elem = d3.select(this);
//                                                        elem.attr("x",elem.attr("initial-x"));
//                                                        elem.attr("y",elem.attr("initial-y"));
//
//                                                    }
//                                                }else
                                        if(mouseCoordinates[0]<320 || mouseCoordinates[1]<=44 || mouseCoordinates[0]>= 980 || mouseCoordinates[1]>= 500){
                                            var elem = d3.select(this);
                                            elem.attr("x",elem.attr("initial-x"));
                                            elem.attr("y",elem.attr("initial-y"));
                                        }
                                    })
                    )

                }


            })
    ;


    var drag = d3.behavior.drag()
                    .on("drag", move)
                    .on("dragend", function(d){
                        var elem = d3.select(this);
                        elem.attr('x', elem.attr('initial-x'));
                        elem.attr('y', elem.attr('initial-y'));

                        var mouseLoc = d3.mouse(this);

                        if(mouseLoc[0] > 320){
                            mainLayout
                                    .append('svg:image')
                                    .attr('width', elem.attr('width'))
                                    .attr('height', elem.attr('height'))
                                    .attr('x', mouseLoc[0])
                                    .attr('initial-x', mouseLoc[0])
                                    .attr('y', mouseLoc[1])
                                    .attr('initial-y', mouseLoc[1])
                                    .attr('xlink:href', elem.attr('href'))

                                    .on('contextmenu', function(d, i){
                                        var curElem = d3.select(this);
                                        d3.event.preventDefault();
//                                        alert('right click disabled');
                                        var position = d3.mouse(this);
                                        d3.select('#elem-right-click')
                                                .style('position', 'absolute')
                                                .style('left', position[0] + "px")
                                                .style('top', position[1] + "px")
                                                .style('display', 'block')
                                                .on('click', function(d, i){

                                                    var conf = confirm('Confiem Delete?');
                                                    if(conf){
                                                        curElem.remove();
                                                    }
                                                    d3.select(this).style('display', 'none');


                                                })
                                        ;


                                    })
                                    .call(d3.behavior.drag()
                                            .on('drag', move)
                                            .on('dragend', function(){
                                                var mouseCoordinates = d3.mouse(this);
//                                                if(mouseCoordinates[0] >= 925 && mouseCoordinates[1]<= 105){
//                                                    var ip = confirm('Are you sure you wanna delete the item? ');
//                                                    if(ip == true){
//                                                        this.remove();
//                                                    }else{
//                                                        var elem = d3.select(this);
//                                                        elem.attr("x",elem.attr("initial-x"));
//                                                        elem.attr("y",elem.attr("initial-y"));
//
//                                                    }
//                                                }else
                                                if(mouseCoordinates[0]<320 || mouseCoordinates[1]<=44 || mouseCoordinates[0]>= 980 || mouseCoordinates[1]>= 500){
                                                    var elem = d3.select(this);
                                                    elem.attr("x",elem.attr("initial-x"));
                                                    elem.attr("y",elem.attr("initial-y"));
                                                }
                                            })
                            )
                            ;

                        }

                    })
            ;

    var tooltip = d3.select("body")
                    .append("div")
                    .style("position", "absolute")
                    .style("z-index", "10")
                    .style("visibility", "hidden")
            ;

    mainLayout.selectAll("image")

            .data(icons)
            .enter()
            .append("svg:image")
            .attr("xlink:href", function(d){
                return "images/icons/"+d;
            })

            .attr('class','drg')
            .attr("width", w)
            .attr("height", h)
            .attr("x", function(d, i){
                return coordinates[i][0];
//                                            return i*10;
            })
            .attr("initial-x", function(d, i){
                return coordinates[i][0];
            })
            .attr("y",function(d, i){
                return coordinates[i][1];
//                                            return i*10;
            })
            .attr('initial-y', function(d, i){
                return coordinates[i][1];
            })


            .call(drag)
            .append('svg:title')
            .text(function(d){
                return d.split('.')[0];
            })


    ;



    var rectObj = {
        id : 'streams',
        x : streamsConfig.x,
        y : streamsConfig.y,
        height : streamsConfig.height,
        width : streamsConfig.width
    };

    var ptree = [['Input Stream','Child One','Child Two','Child Three','Child Four'],['Output Stream','Child One','Child Two','Child Three']];
    drawTree(rectObj,ptree);

    function drawTree(rectElementObj, tree){

        var allObjects = getRectObjects(rectElementObj,tree);
        var textObjects = getTextObjects(rectElementObj,tree);
        var rectObjects = allObjects[0];
        var lineObjects = allObjects[1];


        var rectangles = mainLayout
                .selectAll('rect')
                .data(rectObjects)
                .enter()
                .append('rect');

        rectangles
                .attr("x", function (d) { return d.x; })
                .attr("initial-x", function (d) { return d.x; })
                .attr("y", function (d) { return d.y; })
                .attr("initial-y", function (d) { return d.y; })
                .attr("height", function (d) { return d.height; })
                .attr("width", function (d) { return d.width; })
                .attr("fill", function () { return "white"; })
                .attr("stroke", function () { return "black"; })
                .style("stroke-width", function() { return "1 px"; })
                .attr("draggable",function(d){return d.drag;})
                .call(dragStream)
        ;

        var lines = mainLayout.selectAll("line")
                .data(lineObjects)
                .enter()
                .append("line");

        var lineAttributes = lines
                .attr("x1", function (d) { return d.x1; })
                .attr("x2", function (d) { return d.x2; })
                .attr("y1", function (d) { return d.y1; })
                .attr("y2", function (d) { return d.y2; })
                .attr("stroke", function (d) { return "black"; })
                .style("stroke-width", function(d) { return "1 px"; });


        var texts = mainLayout
                .selectAll('text')
                .data(textObjects)
                .enter();

        texts.append("text")
                .text(function(d){        return d.text; })
                .attr("x", function (d) { return d.x; })
                .attr("y", function (d) { return d.y; })
        ;


    }


    function getRectObjects(rectElementObj, tree){

        //Initial point
        var x0 = Number(rectElementObj.x)+ 20;
        var y0 = Number(rectElementObj.y) + 30;
        var height = Number(rectElementObj.height) - 40;
        var width = Number(rectElementObj.width) - 20;

        var parentOne = tree[0];
        var parentTwo = tree[1];

        var input = parentOne[0];
        var output = parentTwo[0];

        var lenInput = parentOne.length;
        var lenOutput = parentTwo.length;

        var rectangles = (lenInput+ lenOutput);
        var gaps = rectangles - 1;
        var sizeOfGap = 5;
        var heightOfRect = Math.round((height - (sizeOfGap * gaps)) / rectangles);
        var widthOfRect = Math.round(width * 0.4);

        var parents = [{},{},{},
            {
                id:"one",
                x : x0,
                y : y0,
                width : widthOfRect,
                height : heightOfRect,
                drag : 'false'

            },
            {
                id:"two",
                x : x0,
                y : y0 + (lenInput * sizeOfGap) + ((lenInput) * heightOfRect),
                width : widthOfRect,
                height : heightOfRect,
                drag : 'false'

            }];

        var childA = [];
        for (var i = 0; i < lenInput - 1; i++) {
            childA[i] =
            {
                x: x0 + widthOfRect,
                y: y0 + ((i + 1 ) * heightOfRect) + ((i + 1) * sizeOfGap),
                width: widthOfRect,
                height: heightOfRect,
                drag : 'true'
            }
        }

        var childB =[];
        for (var j = 0; j < lenOutput - 1; j++) {
            childB[j] =
            {
                x: x0 + widthOfRect,
                y: (y0 + (lenInput * sizeOfGap) + ((lenInput) * heightOfRect)) +((j + 1 )* heightOfRect) + ((j + 1)* sizeOfGap),
                width :widthOfRect,
                height :heightOfRect,
                drag : 'true'
            }
        }


        var rectObj = parents.concat(childA,childB);


        var vertLine =[];
        if(lenOutput==1){
            vertLine = [
                {   x1: x0 + Math.round(widthOfRect/2),
                    x2: x0 + Math.round(widthOfRect/2),
                    y1: y0 + heightOfRect,
                    y2: y0 + (lenInput * sizeOfGap) + (lenInput * heightOfRect)
                },
                {   x1: x0 + Math.round(widthOfRect/2),
                    x2: x0 + Math.round(widthOfRect/2),
                    y1: y0 + (lenInput * sizeOfGap) + ((lenInput + 1) * heightOfRect),
                    y2: (y0 + (lenInput * sizeOfGap) + ((lenInput + 1) * heightOfRect))
                }
            ];
        }
        else{
            vertLine = [
                {   x1: x0 + Math.round(widthOfRect/2),
                    x2: x0 + Math.round(widthOfRect/2),
                    y1: y0 + heightOfRect,
                    y2: y0 + (lenInput * sizeOfGap) + (lenInput * heightOfRect)
                },
                {   x1: x0 + Math.round(widthOfRect/2),
                    x2: x0 + Math.round(widthOfRect/2),
                    y1: y0 + (lenInput * sizeOfGap) + ((lenInput + 1) * heightOfRect),
                    y2: (y0 + (lenInput * sizeOfGap) + ((lenInput + 1) * heightOfRect)) + ((lenOutput -1) *(sizeOfGap)) + (((2 * lenOutput) -3) * Math.round(heightOfRect/2))
                }
            ];
        }



        var horiLineA =[];
        var horiLineB =[];


        for (var j = 0; j < lenInput - 1; j++) {
            horiLineA[j] =
            {
                x1: x0 + Math.round(widthOfRect/2),
                x2: x0 + widthOfRect,
                y1: y0 + ((j + 1) *(sizeOfGap)) + ((j + 1) * (heightOfRect)) + Math.round(heightOfRect/2),
                y2: y0 + ((j + 1) *(sizeOfGap)) + ((j + 1) * (heightOfRect)) + Math.round(heightOfRect/2)
            }
        }

        for (var j = 0; j < lenOutput - 1; j++) {
            horiLineB[j] =
            {
                x1: x0 + Math.round(widthOfRect/2),
                x2: x0 + widthOfRect,
                y1: (y0 + (lenInput * ( heightOfRect + sizeOfGap))) + ((j + 1) * (sizeOfGap + heightOfRect)) + Math.round(heightOfRect/2),
                y2: (y0 + (lenInput * ( heightOfRect + sizeOfGap))) + ((j + 1) * (sizeOfGap + heightOfRect)) + Math.round(heightOfRect/2)
            }
        }

        var lineObj = vertLine.concat(horiLineA,horiLineB);

        var allObj = [rectObj,lineObj];

        return allObj;
//        return rectObj;



    }

    function getTextObjects(rectElementObj, tree){

        //Initial point
        var x0 = Number(rectElementObj.x)+ 20;
        var y0 = Number(rectElementObj.y) + 30;
        var height = Number(rectElementObj.height) - 40;
        var width = Number(rectElementObj.width) - 20;

        var parentOne = tree[0];
        var parentTwo = tree[1];

        var input = parentOne[0];
        var output = parentTwo[0];

        var lenInput = parentOne.length;
        var lenOutput = parentTwo.length;

        var rectangles = (lenInput+ lenOutput);
        var gaps = rectangles - 1;
        var sizeOfGap = 5;
        var heightOfRect = Math.round((height - (sizeOfGap * gaps)) / rectangles);
        var widthOfRect = Math.round(width * 0.4);


        var parents = [{},{},
            {
                text : input,
                x : x0+sizeOfGap,
                y : y0 +Math.round( 2 * heightOfRect/3)

            },
            {
                text : output,
                x : x0+sizeOfGap,
                y : y0 + (lenInput * sizeOfGap) + ((lenInput) * heightOfRect) + Math.round( 2 * heightOfRect/3)

            }];

        var childA = [];
        for (var i = 0; i < lenInput - 1; i++) {
            childA[i] =
            {
                text : parentOne[i+1],
                x: x0 + widthOfRect + sizeOfGap,
                y: y0 + ((i + 1 ) * heightOfRect) + ((i + 1) * sizeOfGap) + Math.round( 2 * heightOfRect/3)
            }
        }

        var childB =[];
        for (var j = 0; j < lenOutput - 1; j++) {
            childB[j] =
            {
                text : parentTwo[j+1],
                x: x0 + widthOfRect + sizeOfGap,
                y: (y0 + (lenInput * sizeOfGap) + ((lenInput) * heightOfRect)) +((j + 1 )* heightOfRect) + ((j + 1)* sizeOfGap) + Math.round( 2 * heightOfRect/3)

            }
        }


        return parents.concat(childA,childB);

    }


</script>


</body>
</html>